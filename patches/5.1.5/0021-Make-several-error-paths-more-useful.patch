From 003aecbf876f7a61cda85059db4dc403f56500b0 Mon Sep 17 00:00:00 2001
From: Brian Silverman <brian.silverman@bluerivert.com>
Date: Thu, 9 Jan 2020 10:48:24 -0800
Subject: [PATCH 21/33] Make several error paths more useful

Things do a better job recovering this way.
---
 .../media/platform/tegra/camera/vi/vi5_fops.c        | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/kernel/nvidia/drivers/media/platform/tegra/camera/vi/vi5_fops.c b/kernel/nvidia/drivers/media/platform/tegra/camera/vi/vi5_fops.c
index 91fcbd8a6..fe64d0119 100644
--- a/kernel/nvidia/drivers/media/platform/tegra/camera/vi/vi5_fops.c
+++ b/kernel/nvidia/drivers/media/platform/tegra/camera/vi/vi5_fops.c
@@ -668,13 +668,13 @@ static int vi5_channel_error_recover(struct tegra_channel *chan,
 	for (vi_port = 0; vi_port < chan->valid_ports; vi_port++) {
 		err = vi_capture_release(chan->tegra_vi_channel[vi_port],
 			CAPTURE_CHANNEL_RESET_FLAG_IMMEDIATE);
-		if (err) {
+		if (err)
 			dev_err(&chan->video->dev, "vi capture release failed\n");
-			goto done;
-		}
 		vi_channel_close_ex(chan->vi_channel_id[vi_port],
 					chan->tegra_vi_channel[vi_port]);
 		chan->tegra_vi_channel[vi_port] = NULL;
+		if (err)
+			goto done;
 	}
 
 
@@ -718,8 +718,12 @@ static int vi5_channel_error_recover(struct tegra_channel *chan,
 			goto done;
 		}
 		err = tegra_channel_capture_setup(chan, vi_port);
-		if (err < 0)
+		if (err < 0) {
+			vi_channel_close_ex(chan->vi_channel_id[vi_port],
+						chan->tegra_vi_channel[vi_port]);
+			chan->tegra_vi_channel[vi_port] = NULL;
 			goto done;
+		}
 	}
 
 	chan->sequence = 0;
-- 
2.52.0

